@import com.gu.janus.model.{JanusData, Permission, ProvisionedRole}

@(janusData: JanusData, allPermissions: Set[Permission])

janus {
    @janusData.permissionsRepo.map { repoUrl =>
        permissionsRepo = "@repoUrl"
    }

    accounts = [
        @for(account <- janusData.accounts){
            { name = "@account.name", key = "@account.authConfigKey" },
        }
    ]

    support {
        supportAccess = [
            @for(permission <- janusData.support.supportAccess){
                @permissionReference(permission),
            }
        ]

        rota = [
            @for((startTime, (user1, user2)) <- janusData.support.rota){
                {
                    startTime = "@startTime"
                    supporting = [ "@user1", "@user2" ]
                },
            }
        ]
    }

    access {
        defaultPermissions = [
            @for(permission <- janusData.access.defaultPermissions){
                @permissionReference(permission),
            }
        ]

        acl {
            @for((user, aclEntry) <- janusData.access.userAccess){
                "@user" = [
                    @for(permission <- aclEntry.permissions) {
                        @permissionReference(permission)
                    }
                    @for(role <- aclEntry.roles) {
                        { provisionedRoleName = """@role.name""", iamRoleTag = "@role.iamRoleTag" }
                    }
                ]
            },
        }
    }

    admin {
        acl {
            @for((user, aclEntry) <- janusData.admin.userAccess){
                "@user" = [
                    @for(permission <- aclEntry.permissions) {
                        @permissionReference(permission)
                    }
                    @for(role <- aclEntry.roles) {
                        { provisionedRoleName = """@role.name""", iamRoleTag = "@role.iamRoleTag" }
                    }
                ]
            }
        }
    }

    permissions = [
        @for(permission <- allPermissions){
            {
                account = "@permission.account.authConfigKey"
                label = "@permission.label"
                description = """@permission.description"""
                shortTerm = @if(permission.shortTerm) {true} else {false}
                @permission.policy match {
                    case Some(policy) => {
                policy = """@policy"""
                    }
                    case None => {}
                }
                @permission.managedPolicyArns match {
                    case Some(managedPolicyArns) => {
                managedPolicyArns = [
                    @for(arn <- managedPolicyArns) {
                    """@arn""",
                    }
                ]
                    }
                    case None => {}
                }
            },
        }
    ]
}
